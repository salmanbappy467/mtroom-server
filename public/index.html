<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° MeterNet Live Analytics</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .live-badge { background: rgba(34, 197, 94, 0.2); color: var(--success); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid var(--success); }

        /* Top Cards */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card h3 { margin: 0 0 10px 0; color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 32px; font-weight: 800; }
        .card .sub { font-size: 12px; color: var(--text-muted); margin-top: 5px; }

        /* Main Layout */
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* Graph Section */
        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; height: 350px; }
        
        /* Endpoint List */
        .endpoint-list { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .ep-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #334155; }
        .ep-item:last-child { border-bottom: none; }
        .ep-name { font-weight: 600; font-size: 14px; }
        .ep-count { font-weight: bold; color: var(--accent); }

        /* Node Table */
        .node-section { margin-top: 30px; background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: var(--text-muted); padding: 10px; font-size: 12px; border-bottom: 1px solid #334155; }
        td { padding: 12px 10px; border-bottom: 1px solid #334155; font-size: 14px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot-offline { background: var(--danger); }

        /* Responsive */
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="header">
        <h1>‚ö° MeterNet <span style="font-weight:300; opacity:0.7;">Analytics</span></h1>
        <div class="live-badge">‚óè SYSTEM LIVE</div>
    </div>

    <div class="grid-cards">
        <div class="card">
            <h3>Online Nodes</h3>
            <div class="value" id="val-nodes" style="color: var(--accent)">0</div>
            <div class="sub">Currently Connected</div>
        </div>
        <div class="card">
            <h3>Total Requests (Today)</h3>
            <div class="value" id="val-total">0</div>
            <div class="sub">Since 12:00 AM</div>
        </div>
        <div class="card">
            <h3>Success Rate</h3>
            <div class="value" id="val-success" style="color: var(--success)">0%</div>
            <div class="sub" id="sub-failed">0 Failed</div>
        </div>
        <div class="card">
            <h3>Queue Pending</h3>
            <div class="value" id="val-queue" style="color: var(--warning)">0</div>
            <div class="sub">Waiting to process</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>

        <div class="endpoint-list">
            <h3 style="margin-top:0; color:#fff;">üì° Endpoint Usage</h3>
            <div id="ep-container">
                <div class="ep-item"><span>Loading...</span></div>
            </div>
        </div>
    </div>

    <div class="node-section">
        <h3 style="margin:0; color:#fff;">üñ•Ô∏è Active Worker Nodes</h3>
        <table id="nodeTable">
            <thead>
                <tr>
                    <th>MACHINE NAME</th>
                    <th>STATUS</th>
                    <th>ID</th>
                    <th>SUCCESS / FAIL (LIFETIME)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const socket = io({ query: { type: 'dashboard' } });

        // --- Chart Initialization ---
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Requests per Hour',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Traffic Volume (Last 24 Hours)', color: '#94a3b8' }
                },
                scales: {
                    x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, beginAtZero: true }
                }
            }
        });

        // --- Data Fetching ---
        async function updateDashboard() {
            try {
                const res = await fetch('/api/dashboard-data');
                const data = await res.json();

                // 1. Update Cards
                document.getElementById('val-nodes').innerText = data.onlineNodeCount;
                document.getElementById('val-total').innerText = data.stats.totalToday;
                document.getElementById('val-queue').innerText = data.stats.queued;
                
                // Success Calculation
                const totalProcessed = data.stats.completed + data.stats.failed;
                const rate = totalProcessed > 0 ? Math.round((data.stats.completed / totalProcessed) * 100) : 0;
                document.getElementById('val-success').innerText = rate + "%";
                document.getElementById('sub-failed').innerText = `${data.stats.failed} Failed Today`;

                // 2. Update Graph
                chart.data.labels = data.graphData.labels;
                chart.data.datasets[0].data = data.graphData.data;
                chart.update();

                // 3. Update Endpoint List
                const epContainer = document.getElementById('ep-container');
                epContainer.innerHTML = '';
                const labels = {
                    'LOGIN_CHECK': 'Login Verify',
                    'METER_POST': 'Bulk Meter Post',
                    'FAST_POST': 'Fast Upload',
                    'SINGLE_CHECK': 'Single Check',
                    'INVENTORY': 'Inventory List'
                };
                
                for (const [key, val] of Object.entries(data.endpointStats)) {
                    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ø‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßã
                    if(true) { 
                        epContainer.innerHTML += `
                            <div class="ep-item">
                                <span class="ep-name">${labels[key] || key}</span>
                                <span class="ep-count">${val}</span>
                            </div>
                        `;
                    }
                }

                // 4. Update Node Table
                const tbody = document.querySelector('#nodeTable tbody');
                tbody.innerHTML = '';
                
                // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶è‡¶∞ ‡¶®‡ßã‡¶° ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá
                data.nodes.forEach(node => {
                    // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ö‡ßá‡¶ï: ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßá ‡¶è‡¶á ‡¶®‡ßã‡¶° ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                    // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã onlineNodeCount ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡ßá‡¶≤‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø,
                    // ‡¶§‡¶¨‡ßá ‡¶®‡ßã‡¶°‡ßá‡¶∞ status ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶õ‡¶ø‡•§
                    
                    const isOnline = node.status === 'online';
                    const statusHtml = isOnline 
                        ? `<span class="status-dot dot-online"></span><span style="color:#22c55e">ONLINE</span>`
                        : `<span class="status-dot dot-offline"></span><span style="color:#ef4444">OFFLINE</span>`;

                    const row = `
                        <tr>
                            <td style="font-weight:600; color:#fff">${node.name || 'Unknown'}</td>
                            <td>${statusHtml}</td>
                            <td style="font-family:monospace; color:#94a3b8">${node.machineId}</td>
                            <td>
                                <span style="color:#22c55e">${node.totalSuccess}</span> / 
                                <span style="color:#ef4444">${node.totalFailed}</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (e) {
                console.error("Dashboard update failed", e);
            }
        }

        // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
        setInterval(updateDashboard, 3000);
        updateDashboard();

        // Socket ‡¶¶‡¶ø‡ßü‡ßá‡¶ì ‡¶∞‡¶ø‡ßü‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)
        socket.on('dashboard_update', () => updateDashboard());

    </script>
</body>
</html>